<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard LTT</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>

<style>

body{
font-family:Segoe UI;
margin:0;
background:url("https://png.pngtree.com/thumb_back/fh260/background/20240705/pngtree-view-of-green-rice-fields-with-morning-dew-and-mountains-with-image_15859864.jpg") center/cover fixed;
}

.overlay{
background:rgba(255,255,255,0.92);
min-height:100vh;
padding:20px;
}

header{
display:flex;
align-items:center;
gap:15px;
margin-bottom:20px;
}

header img{
width:65px;
background:white;
border-radius:10px;
padding:4px;
}

.title{
font-size:22px;
font-weight:700;
color:#1b4332;
}

.score{
background:#2d6a4f;
color:white;
padding:14px;
border-radius:10px;
text-align:center;
font-size:20px;
margin-bottom:20px;
}

.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
gap:15px;
}

.card{
background:white;
padding:15px;
border-radius:12px;
box-shadow:0 4px 10px rgba(0,0,0,0.1);
}

.menu{
display:flex;
flex-wrap:wrap;
gap:8px;
margin-bottom:10px;
}

.menu button{
background:#40916c;
border:none;
color:white;
padding:7px 12px;
border-radius:8px;
cursor:pointer;
font-size:13px;
}

.menu button:hover{
background:#1b4332;
}

table{
width:100%;
border-collapse:collapse;
font-size:13px;
}

th{
background:#2d6a4f;
color:white;
padding:7px;
}

td{
padding:6px;
border-bottom:1px solid #ddd;
}

.action{
margin-bottom:10px;
}

.action button{
background:#2d6a4f;
border:none;
color:white;
padding:6px 12px;
border-radius:6px;
cursor:pointer;
margin-right:6px;
}

.rank{
font-weight:bold;
color:#1b4332;
}

</style>
</head>

<body>

<div class="overlay" id="areaDashboard">

<header>
<img src="https://upload.wikimedia.org/wikipedia/commons/9/9a/Coat_of_arms_of_Riau.png">
<div>
<div class="title">Dashboard LTT Kabupaten</div>
</div>
</header>

<div class="score" id="total">Memuat data...</div>

<div class="grid">

<div class="card">
<h3>Grafik Jenis LTT</h3>
<canvas id="chartJenis"></canvas>
</div>

<div class="card">
<h3>Ranking Kecamatan</h3>
<canvas id="chartRanking"></canvas>
</div>

<div class="card">
<h3>Grafik Mingguan</h3>
<canvas id="chartMinggu"></canvas>
</div>

<div class="card">
<h3>Grafik Bulanan</h3>
<canvas id="chartBulan"></canvas>
</div>

<div class="card" style="grid-column:1/-1">

<h3>Data Rekap</h3>

<div class="menu">
<button onclick="ganti('jenis_total')">Jenis LTT Kabupaten</button>
<button onclick="ganti('jenis_kecamatan')">Jenis per Kecamatan</button>
<button onclick="ganti('jenis_desa')">Jenis per Desa</button>
<button onclick="ganti('kecamatan')">Rekap Kecamatan</button>
<button onclick="ganti('desa')">Rekap Desa</button>
<button onclick="ganti('poktan')">Rekap Poktan</button>
</div>

<div class="action">
<button onclick="downloadExcel()">Download Excel</button>
<button onclick="downloadPDF()">Download PDF</button>
</div>

<div id="tabel">Memuat...</div>

</div>

</div>
</div>

<script>

const url="https://script.google.com/macros/s/AKfycby2-GIC6Rx_atSv-Y65VjJedMMYhbJFuI_qYMrvFgWXzdWME8yrfnsIsU1bsvsDtgHg/exec";

let DATA;
let mode="jenis_total";
let tabelData=[];

async function load(){

const res=await fetch(url);
DATA=await res.json();

document.getElementById("total").innerHTML=
"TOTAL LTT : "+DATA.total_kabupaten+" Ha";

buatGrafik("chartJenis",DATA.jenis_total);
buatGrafik("chartRanking",DATA.kecamatan_total);
buatGrafik("chartMinggu",DATA.mingguan || {"M1":0});
buatGrafik("chartBulan",DATA.bulanan || {"Jan":0});

render();
}

function buatGrafik(id,data){
new Chart(document.getElementById(id),{
type:"bar",
data:{
labels:Object.keys(data),
datasets:[{data:Object.values(data)}]
},
options:{responsive:true}
});
}

function ganti(m){
mode=m;
render();
}

function render(){

let html="<table>";
tabelData=[];

if(mode=="jenis_total"){
html+="<tr><th>Jenis LTT</th><th>Luas</th></tr>";
for(let i in DATA.jenis_total){
html+=`<tr><td>${i}</td><td>${DATA.jenis_total[i]}</td></tr>`;
tabelData.push([i,DATA.jenis_total[i]]);
}
}

if(mode=="kecamatan"){
html+="<tr><th>Kecamatan</th><th>Luas</th></tr>";
for(let i in DATA.kecamatan_total){
html+=`<tr><td>${i}</td><td>${DATA.kecamatan_total[i]}</td></tr>`;
tabelData.push([i,DATA.kecamatan_total[i]]);
}
}

if(mode=="desa"){
html+="<tr><th>Desa</th><th>Luas</th></tr>";
for(let i in DATA.desa_total){
html+=`<tr><td>${i}</td><td>${DATA.desa_total[i]}</td></tr>`;
tabelData.push([i,DATA.desa_total[i]]);
}
}

if(mode=="poktan" && DATA.poktan_total){
html+="<tr><th>Poktan</th><th>Luas</th></tr>";
for(let i in DATA.poktan_total){
html+=`<tr><td>${i}</td><td>${DATA.poktan_total[i]}</td></tr>`;
tabelData.push([i,DATA.poktan_total[i]]);
}
}

html+="</table>";
document.getElementById("tabel").innerHTML=html;

}

function downloadExcel(){

let wb=XLSX.utils.book_new();
let ws=XLSX.utils.aoa_to_sheet([["Nama","Luas"],...tabelData]);
XLSX.utils.book_append_sheet(wb,ws,"Rekap");
XLSX.writeFile(wb,"rekap_ltt.xlsx");

}

async function downloadPDF(){

const element=document.getElementById("areaDashboard");
const canvas=await html2canvas(element);
const img=canvas.toDataURL("image/png");

const { jsPDF } = window.jspdf;
const pdf=new jsPDF("l","mm","a4");

pdf.addImage(img,"PNG",5,5,287,200);
pdf.save("dashboard_ltt.pdf");

}

load();

</script>

</body>
</html>
