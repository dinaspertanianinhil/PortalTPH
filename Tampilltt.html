<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Monitoring LTT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>

body{
margin:0;
font-family:Inter,Segoe UI;
background:
linear-gradient(rgba(3,20,13,0.75),rgba(3,20,13,0.75)),
url("https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTvxh4_NzxPObs3auPYoJIUojZJvrn6v1Akhw&s");
background-size:cover;
background-attachment:fixed;
color:white;
}

.navbar{
display:flex;
justify-content:space-between;
align-items:center;
padding:10px 25px;
background:white;
box-shadow:0 3px 12px rgba(0,0,0,0.2);
flex-wrap:wrap;
gap:15px;
z-index:10000;
}

.logo-area{
display:flex;
align-items:center;
gap:12px;
}

.logo-area img{
height:50px;
}

.title{
font-weight:700;
font-size:15px;
color:#064e3b;
line-height:1.2;
}

.menu{
display:flex;
gap:10px;
flex-wrap:wrap;
}

.menu button{
background:#0f5132;
border:none;
color:white;
padding:8px 14px;
border-radius:8px;
cursor:pointer;
font-weight:600;
}

.menu button:hover{
background:#198754;
}

.dropdown{
position:relative;
}

.dropdown-content{
position:absolute;
top:42px;
left:0;
background:#0f5132;
border-radius:10px;
min-width:200px;
box-shadow:0 8px 20px rgba(0,0,0,0.4);
overflow:hidden;
z-index:999999;
opacity:0;
transform:translateY(-10px);
pointer-events:none;
transition:.25s;
}

.dropdown-content.show{
opacity:1;
transform:translateY(0);
pointer-events:auto;
}

.dropdown-content button{
width:100%;
border:none;
background:none;
color:white;
padding:10px;
text-align:left;
cursor:pointer;
}

.dropdown-content button:hover{
background:#198754;
}

.container{
max-width:1400px;
margin:auto;
padding:20px;
}

.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
gap:20px;
}

.card{
background:rgba(7,61,37,0.9);
padding:18px;
border-radius:14px;
box-shadow:0 5px 25px rgba(0,0,0,0.4);
}

.score{
font-size:30px;
font-weight:700;
text-align:center;
color:#4ade80;
}

.rank-list{
display:flex;
flex-direction:column;
gap:8px;
}

.rank-item{
display:flex;
justify-content:space-between;
padding:10px;
border-radius:8px;
font-weight:600;
background:#14532d;
}

.gold{background:#FFD700;color:black;}
.silver{background:#C0C0C0;color:black;}
.bronze{background:#CD7F32;}

.rekap-view{
display:none;
max-width:1200px;
margin:auto;
background:rgba(7,61,37,0.95);
padding:20px;
border-radius:12px;
}

table{
width:100%;
border-collapse:collapse;
background:white;
color:black;
}

th{
background:#198754;
color:white;
padding:8px;
}

td{
padding:8px;
border:1px solid #ccc;
text-align:center;
}

</style>
</head>

<body>

<div class="navbar">

<div class="logo-area">
<img src="https://upload.wikimedia.org/wikipedia/commons/a/a3/Logo_kabupaten_indragiri_hilir.jpg">
<div class="title">
Bidang Tanaman Pangan dan Hortikultura<br>
Dinas Pertanian Kabupaten Indragiri Hilir
</div>
</div>

<div class="menu">

<button onclick="location.href='dashboad.html'">Dashboard</button>

<div class="dropdown">
<button onclick="toggleMenu('menu1')">Rekap Jenis LTT</button>
<div class="dropdown-content" id="menu1">
<button onclick="openRekap('jenis_total')">Kabupaten</button>
<button onclick="openRekap('jenis_kecamatan')">Kecamatan</button>
<button onclick="openRekap('jenis_desa')">Desa</button>
</div>
</div>

<div class="dropdown">
<button onclick="toggleMenu('menu2')">Rekap Bulanan</button>
<div class="dropdown-content" id="menu2">
<button onclick="openRekap('bulan_kab')">Kabupaten</button>
<button onclick="openRekap('bulan_kec')">Kecamatan</button>
<button onclick="openRekap('bulan_desa')">Desa</button>
</div>
</div>

<div class="dropdown">
<button onclick="toggleMenu('menu3')">Rekap Musim Tanam</button>
<div class="dropdown-content" id="menu3">
<button onclick="openRekap('musim_kab')">Kabupaten</button>
<button onclick="openRekap('musim_kec')">Kecamatan</button>
<button onclick="openRekap('musim_desa')">Desa</button>
</div>
</div>

</div>
</div>

<div id="dashboard" class="container">

<div class="grid">

<div class="card">
<h3>Grafik Jenis LTT</h3>
<canvas id="chartJenis"></canvas>
</div>

<div class="card">
<h3>Grafik Ranking Kecamatan</h3>
<canvas id="chartKecamatan"></canvas>
</div>

<div class="card">
<h3>Total Hari Ini (Reguler + Oplah)</h3>
<div class="score" id="scorePadi">Memuat...</div>
</div>

<div class="card">
<h3>Total Semua LTT</h3>
<div class="score" id="scoreSemua">Memuat...</div>
</div>

<div class="card">
<h3>Ranking Realisasi</h3>
<div class="rank-list" id="ranking"></div>
</div>

</div>

</div>

<div id="rekap" class="rekap-view">

<button onclick="kembali()">Kembali</button>

<div style="margin:10px 0;">
<button onclick="downloadExcel()">Download Excel</button>
<button onclick="downloadPDF()">Download PDF</button>
</div>

<div id="tabel"></div>

</div>

<script>

const url="https://script.google.com/macros/s/AKfycby2-GIC6Rx_atSv-Y65VjJedMMYhbJFuI_qYMrvFgWXzdWME8yrfnsIsU1bsvsDtgHg/exec";

let DATA;
let mode;
let chartStore={};

function toggleMenu(id){
document.querySelectorAll(".dropdown-content")
.forEach(menu=>menu.classList.remove("show"));
document.getElementById(id).classList.toggle("show");
}

document.addEventListener("click",function(e){
if(!e.target.closest(".dropdown")){
document.querySelectorAll(".dropdown-content")
.forEach(menu=>menu.classList.remove("show"));
}
});

async function load(){
const res=await fetch(url);
DATA=await res.json();
updateDashboard();
}

function updateDashboard(){

buatGrafik("chartJenis",DATA.jenis_total);
buatGrafik("chartKecamatan",DATA.kecamatan_total);

buatRanking();

/* papan skor padi */
let reguler = DATA.jenis_total.reguler || 0;
let oplah = DATA.jenis_total.oplah || 0;

document.getElementById("scorePadi").innerHTML =
reguler + oplah + " Ha";

/* papan skor semua jenis */
let totalSemua = 0;
for(let i in DATA.jenis_total){
totalSemua += DATA.jenis_total[i];
}
document.getElementById("scoreSemua").innerHTML =
totalSemua + " Ha";

}

function buatGrafik(id,data){

const label=Object.keys(data);
const nilai=Object.values(data);

if(chartStore[id]) chartStore[id].destroy();

chartStore[id]=new Chart(document.getElementById(id),{
type:"bar",
data:{labels:label,datasets:[{data:nilai,borderRadius:8}]},
options:{plugins:{legend:{display:false}}}
});
}

function buatRanking(){

let sorted=Object.entries(DATA.kecamatan_total)
.sort((a,b)=>b[1]-a[1]);

let html="";

sorted.forEach((row,i)=>{

let kelas="rank-item";
if(i==0) kelas+=" gold";
else if(i==1) kelas+=" silver";
else if(i==2) kelas+=" bronze";

html+=`<div class="${kelas}">
<span>${i+1}. ${row[0]}</span>
<span>${row[1]} Ha</span>
</div>`;
});

document.getElementById("ranking").innerHTML=html;
}

function openRekap(m){
mode=m;
document.getElementById("dashboard").style.display="none";
document.getElementById("rekap").style.display="block";
render();
}

function kembali(){
document.getElementById("dashboard").style.display="block";
document.getElementById("rekap").style.display="none";
}

function render(){

let html="<table>";

if(mode==="jenis_total"){
let r = DATA.jenis_total.reguler || 0;
let o = DATA.jenis_total.oplah || 0;
html+="<tr><th>Jenis</th><th>Luas</th></tr>";
html+=`<tr><td>Reguler</td><td>${r}</td></tr>`;
html+=`<tr><td>Oplah</td><td>${o}</td></tr>`;
html+=`<tr><td><b>Total</b></td><td><b>${r+o}</b></td></tr>`;
}

if(mode==="jenis_kecamatan"){
html+="<tr><th>Kecamatan</th><th>Reguler</th><th>Oplah</th><th>Total</th></tr>";
for(let i in DATA.jenis_per_kecamatan){
let r=DATA.jenis_per_kecamatan[i].reguler||0;
let o=DATA.jenis_per_kecamatan[i].oplah||0;
html+=`<tr><td>${i}</td><td>${r}</td><td>${o}</td><td><b>${r+o}</b></td></tr>`;
}
}

if(mode==="jenis_desa"){
html+="<tr><th>Desa</th><th>Reguler</th><th>Oplah</th><th>Total</th></tr>";
for(let i in DATA.jenis_per_desa){
let r=DATA.jenis_per_desa[i].reguler||0;
let o=DATA.jenis_per_desa[i].oplah||0;
html+=`<tr><td>${i}</td><td>${r}</td><td>${o}</td><td><b>${r+o}</b></td></tr>`;
}
}

html+="</table>";
document.getElementById("tabel").innerHTML=html;
}

function downloadExcel(){
let table=document.querySelector("#tabel table");
let wb=XLSX.utils.book_new();
let ws=XLSX.utils.table_to_sheet(table);
XLSX.utils.book_append_sheet(wb,ws,"Rekap");
XLSX.writeFile(wb,"Rekap_LTT.xlsx");
}

function downloadPDF(){
const { jsPDF } = window.jspdf;
const pdf=new jsPDF("l","mm","a4");
let table=document.querySelector("#tabel table");
let rows=table.querySelectorAll("tr");
let y=20;
rows.forEach(row=>{
pdf.text(row.innerText,14,y);
y+=8;
});
pdf.save("Rekap_LTT.pdf");
}

setInterval(()=>{ load(); },60000);
load();

</script>

</body>
</html>