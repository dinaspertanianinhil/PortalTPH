<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard LTT</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>

body{
font-family:Segoe UI;
margin:0;
padding:20px;
background-image:url("https://png.pngtree.com/thumb_back/fh260/background/20240731/pngtree-beautiful-landscape-of-a-rice-field-and-sky-in-the-village-image_15937834.jpg");
background-size:cover;
background-position:center;
background-attachment:fixed;
}

/* overlay biar tulisan tetap jelas */
body::before{
content:"";
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:rgba(255,255,255,0.85);
z-index:-1;
}

.header{
display:flex;
align-items:center;
gap:15px;
margin-bottom:15px;
}

.logo{
width:70px;
}

.judul{
font-size:22px;
font-weight:600;
}

.score{
background:#2d6a4f;
color:white;
padding:15px;
border-radius:10px;
font-size:20px;
margin-bottom:20px;
text-align:center;
}

.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
gap:15px;
}

.card{
background:white;
padding:15px;
border-radius:10px;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
}

.menu{
margin-bottom:10px;
}

.menu button{
background:#40916c;
border:none;
color:white;
padding:7px 14px;
margin:4px;
border-radius:6px;
cursor:pointer;
}

.menu button:hover{
background:#2d6a4f;
}

/* tombol aktif */
.menu button.active{
background:#1b4332;
}

table{
width:100%;
border-collapse:collapse;
}

th{
background:#2d6a4f;
color:white;
padding:6px;
}

td{
padding:6px;
border-bottom:1px solid #ddd;
text-align:center;
}

/* tambahan supaya tabel tidak kepanjangan */
#tabel{
overflow-x:auto;
}

/* MOBILE FRIENDLY (TAMBAHAN SAJA) */
@media (max-width:768px){

body{
padding:10px;
}

.header{
flex-direction:column;
align-items:flex-start;
}

.logo{
width:55px;
}

.judul{
font-size:18px;
}

.score{
font-size:16px;
}

.grid{
grid-template-columns:1fr;
}

.menu button{
font-size:12px;
padding:6px 10px;
}

table{
min-width:600px;
}

}

</style>
</head>

<body>

<div id="dashboard">

<div class="header">
<img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/a/a3/Logo_kabupaten_indragiri_hilir.jpg">
<div class="judul">Dashboard LTT Kabupaten</div>
</div>

<div class="score" id="total">Memuat...</div>

<div class="grid">

<div class="card">
<h3>Grafik Jenis LTT</h3>
<canvas id="chartJenis"></canvas>
</div>

<div class="card">
<h3>Ranking Kecamatan</h3>
<canvas id="chartKecamatan"></canvas>
</div>

<div class="card" style="grid-column:1/-1">

<h3>Rekap Data</h3>

<div class="menu">
<button onclick="setMode(this,'jenis_total')">Jenis LTT Kabupaten</button>
<button onclick="setMode(this,'jenis_kecamatan')">Jenis LTT Kecamatan</button>
<button onclick="setMode(this,'jenis_desa')">Jenis LTT Desa</button>
<button onclick="setMode(this,'kecamatan')">Rekap Kecamatan</button>
<button onclick="setMode(this,'desa')">Rekap Desa</button>
<button onclick="setMode(this,'poktan')">Rekap Poktan</button>
<button onclick="setMode(this,'mingguan')">Rekap Mingguan</button>
<button onclick="setMode(this,'bulanan')">Rekap Bulanan</button>
<button onclick="downloadExcel()">Download Excel</button>
<button onclick="downloadPDF()">Download PDF</button>
</div>

<div id="tabel">Memuat data...</div>

</div>

</div>
</div>

<script>

const url="https://script.google.com/macros/s/AKfycby2-GIC6Rx_atSv-Y65VjJedMMYhbJFuI_qYMrvFgWXzdWME8yrfnsIsU1bsvsDtgHg/exec";

let DATA;
let mode="jenis_total";

function setMode(btn,m){
mode=m;

/* tandai tombol aktif */
document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");

render();
}

async function load(){

const res=await fetch(url);
DATA=await res.json();

document.getElementById("total").innerHTML=
"Total LTT Kabupaten : "+(DATA.total_kabupaten||0)+" Ha";

buatGrafik("chartJenis",DATA.jenis_total||{});
buatGrafik("chartKecamatan",DATA.kecamatan_total||{});

render();

}

function buatGrafik(id,data){

const label=Object.keys(data||{});
const nilai=Object.values(data||{});

new Chart(document.getElementById(id),{
type:"bar",
data:{
labels:label,
datasets:[{data:nilai}]
},
options:{
plugins:{legend:{display:false}},
responsive:true,
maintainAspectRatio:false
}
});

}

function render(){

if(!DATA){
document.getElementById("tabel").innerHTML="Data belum masuk...";
return;
}

let html="<table>";

if(mode==="jenis_total"){

html+="<tr><th>Jenis LTT</th><th>Luas</th></tr>";
for(let i in DATA.jenis_total){
html+=`<tr><td>${i}</td><td>${DATA.jenis_total[i]}</td></tr>`;
}

}

if(mode==="jenis_kecamatan"){

let jenisSet=new Set();

for(let kec in DATA.jenis_per_kecamatan){
for(let jenis in DATA.jenis_per_kecamatan[kec]){
jenisSet.add(jenis);
}
}

let jenisList=[...jenisSet];

html+="<tr><th>Kecamatan</th>";
jenisList.forEach(j=>html+=`<th>${j}</th>`);
html+="</tr>";

for(let kec in DATA.jenis_per_kecamatan){

html+=`<tr><td>${kec}</td>`;

jenisList.forEach(j=>{
let nilai=DATA.jenis_per_kecamatan[kec][j]||0;
html+=`<td>${nilai}</td>`;
});

html+="</tr>";
}

}

if(mode==="jenis_desa"){

let jenisSet=new Set();

for(let desa in DATA.jenis_per_desa){
for(let jenis in DATA.jenis_per_desa[desa]){
jenisSet.add(jenis);
}
}

let jenisList=[...jenisSet];

html+="<tr><th>Desa</th>";
jenisList.forEach(j=>html+=`<th>${j}</th>`);
html+="</tr>";

for(let desa in DATA.jenis_per_desa){

html+=`<tr><td>${desa}</td>`;

jenisList.forEach(j=>{
let nilai=DATA.jenis_per_desa[desa][j]||0;
html+=`<td>${nilai}</td>`;
});

html+="</tr>";
}

}

if(mode==="kecamatan"){

html+="<tr><th>Kecamatan</th><th>Luas</th></tr>";
for(let i in DATA.kecamatan_total){
html+=`<tr><td>${i}</td><td>${DATA.kecamatan_total[i]}</td></tr>`;
}

}

if(mode==="desa"){

html+="<tr><th>Desa</th><th>Luas</th></tr>";
for(let i in DATA.desa_total){
html+=`<tr><td>${i}</td><td>${DATA.desa_total[i]}</td></tr>`;
}

}

if(mode==="poktan"){

html+="<tr><th>Poktan</th><th>Luas</th></tr>";
for(let i in DATA.poktan_total){
html+=`<tr><td>${i}</td><td>${DATA.poktan_total[i]}</td></tr>`;
}

}

if(mode==="mingguan"){
html+="<tr><th>Minggu</th><th>Total LTT</th></tr>";
html+="<tr><td>Minggu berjalan</td><td>"+DATA.total_kabupaten+"</td></tr>";
}

if(mode==="bulanan"){
html+="<tr><th>Bulan</th><th>Total LTT</th></tr>";
html+="<tr><td>Bulan berjalan</td><td>"+DATA.total_kabupaten+"</td></tr>";
}

html+="</table>";
document.getElementById("tabel").innerHTML=html;

}

function downloadExcel(){

let wb=XLSX.utils.book_new();
let table=document.querySelector("#tabel table");
let ws=XLSX.utils.table_to_sheet(table);
XLSX.utils.book_append_sheet(wb,ws,"Rekap");
XLSX.writeFile(wb,"rekap_ltt.xlsx");

}

async function downloadPDF(){

const element=document.getElementById("dashboard");

const canvas=await html2canvas(element,{scale:2});
const img=canvas.toDataURL("image/png");

const { jsPDF } = window.jspdf;
const pdf=new jsPDF("l","mm","a4");

pdf.addImage(img,"PNG",5,5,287,200);
pdf.save("dashboard_ltt.pdf");

}

load();

</script>

</body>
</html>
